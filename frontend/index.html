<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MediMatch AI | Clinical Decision Support</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Mobile Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Custom Config for Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        medical: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9', // Primary Blue
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        slate: {
                            850: '#1e293b', 
                            900: '#0f172a',
                        },
                    },
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(14, 165, 233, 0.3)',
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .glass-overlay {
            background: rgba(15, 23, 42, 0.3);
            backdrop-filter: blur(8px);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 h-screen overflow-hidden selection:bg-medical-500 selection:text-white">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const MEDICINE_DB = [
            { name: "Amoxicillin", category: "Antibiotic", use: "Treats bacterial infections.", sideEffects: "Nausea, rash, diarrhea.", caution: "Finish the full course even if feeling better." },
            { name: "Ibuprofen", category: "NSAID", use: "Relieves pain, fever, and inflammation.", sideEffects: "Stomach upset, heartburn.", caution: "Take with food. Avoid if you have ulcers." },
            { name: "Warfarin", category: "Anticoagulant", use: "Prevents blood clots.", sideEffects: "Severe bleeding, bruising.", caution: "Regular blood tests (INR) required. Watch Vitamin K intake." },
            { name: "Paracetamol", category: "Analgesic", use: "Treats mild pain and fever.", sideEffects: "Rare; liver damage in overdose.", caution: "Do not exceed 4g per day." },
            { name: "Atorvastatin", category: "Statin", use: "Lowers cholesterol.", sideEffects: "Muscle pain, digestive issues.", caution: "Avoid large amounts of grapefruit juice." },
            { name: "Metformin", category: "Antidiabetic", use: "Treats type 2 diabetes.", sideEffects: "Nausea, stomach upset.", caution: "Take with meals to reduce side effects." }
        ];

        // --- COMPONENT: LOGIN OVERLAY (Glassmorphism) ---
        const LoginOverlay = ({ onLogin }) => {
            const [id, setId] = useState("");
            const [loading, setLoading] = useState(false);

            const handleSubmit = () => {
                if(!id) return;
                setLoading(true);
                setTimeout(() => onLogin(id), 800);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-slate-900 via-medical-900 to-slate-900 p-4 animate-fade-in">
                    {/* Abstract Background Shapes */}
                    <div className="absolute top-0 left-0 w-full h-full overflow-hidden z-0">
                        <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-medical-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-float"></div>
                        <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-float" style={{animationDelay: '2s'}}></div>
                    </div>

                    <div className="relative z-10 w-full max-w-md bg-white/90 backdrop-blur-xl p-10 rounded-3xl shadow-2xl border border-white/20 transform transition-all">
                        <div className="text-center mb-8">
                            <div className="flex justify-center mb-4">
                                <img src="logo medimatch.png" alt="MediMatch Logo" className="h-60 w-auto object-contain drop-shadow-md animate-float" />
                            </div>
                            <p className="text-slate-500 mt-2 font-medium">Secure Clinical Workspace</p>
                        </div>
                        
                        <div className="space-y-6">
                            <div className="group">
                                <label className="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 ml-1">UserName</label>
                                <div className="relative">
                                    <i className="fas fa-user-md absolute left-4 top-4 text-slate-400 group-focus-within:text-medical-500 transition-colors"></i>
                                    <input 
                                        type="text" 
                                        placeholder="Enter ID (e.g., Doc123)"
                                        className="w-full pl-11 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-medical-500 focus:border-medical-500 outline-none text-lg font-semibold text-slate-700 transition-all shadow-inner"
                                        value={id}
                                        onChange={(e) => setId(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && handleSubmit()}
                                        autoFocus
                                    />
                                </div>
                            </div>
                            <button 
                                onClick={handleSubmit}
                                disabled={!id || loading}
                                className="w-full bg-gradient-to-r from-medical-600 to-medical-500 hover:from-medical-500 hover:to-medical-400 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl hover:shadow-medical-500/20 transform hover:-translate-y-0.5 transition-all disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                            >
                                {loading ? <i className="fas fa-circle-notch fa-spin"></i> : <span>Authenticate <i className="fas fa-arrow-right ml-2"></i></span>}
                            </button>
                        </div>
                        <div className="mt-8 text-center">
                            <span className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-green-50 text-green-700 text-xs font-bold border border-green-100">
                                <i className="fas fa-lock"></i> HIPAA Compliant
                            </span>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: SIDEBAR (Modern) ---
        const Sidebar = ({ activeTab, setActiveTab, user, onLogout }) => {
            const menuItems = [
                { id: 'home', icon: 'fa-microscope', label: 'Analysis' },
                { id: 'history', icon: 'fa-file-medical', label: 'Patient History' },
                { id: 'info', icon: 'fa-book-medical', label: 'Drug Reference' },
                { id: 'checker', icon: 'fa-laptop-medical', label: 'Interactions' },
            ];

            return (
                <div className="w-20 lg:w-72 bg-[#E8F1F8] border-r border-slate-200 flex flex-col h-full shrink-0 z-20 transition-all duration-300">
                    {/* Brand */}
                    <div className="h-64 flex items-center justify-center border-b border-slate-100 p-4">
                        {/* UPDATED LOGO SIZE: Increased 2x and removed text */}
                        <div className="flex items-center justify-center w-full">
                            <img src="logo medimatch.png" alt="Logo" className="w-full h-48 object-contain" />
                        </div>
                    </div>

                    {/* Navigation */}
                    <div className="flex-1 py-6 px-3 space-y-2 overflow-y-auto custom-scrollbar">
                        <p className="hidden lg:block px-4 mb-2 text-xs font-bold text-slate-400 uppercase tracking-widest">Modules</p>
                        {menuItems.map(item => (
                            <button
                                key={item.id}
                                onClick={() => setActiveTab(item.id)}
                                className={`w-full flex items-center gap-4 px-3 lg:px-4 py-3.5 rounded-xl transition-all duration-200 group relative overflow-hidden ${
                                    activeTab === item.id 
                                    ? 'bg-medical-50 text-medical-700 font-bold shadow-sm' 
                                    : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900 font-medium'
                                }`}
                            >
                                {activeTab === item.id && <div className="absolute left-0 top-0 bottom-0 w-1 bg-medical-500 rounded-r-full"></div>}
                                <i className={`fas ${item.icon} w-6 text-center text-lg ${activeTab === item.id ? 'text-medical-600' : 'text-slate-400 group-hover:text-slate-600'}`}></i>
                                <span className="hidden lg:block">{item.label}</span>
                            </button>
                        ))}
                    </div>

                    {/* User Profile */}
                    <div className="p-4 border-t border-slate-100 bg-slate-50/50">
                        <div className="flex items-center gap-3 p-2 rounded-xl border border-slate-200/60 bg-white shadow-sm">
                            <div className="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-white font-bold shadow-md">
                                {user.charAt(0).toUpperCase()}
                            </div>
                            <div className="hidden lg:block flex-1 overflow-hidden">
                                <p className="text-sm font-bold text-slate-800 truncate">{user}</p>
                                <p className="text-xs text-medical-600 font-medium">Online</p>
                            </div>
                            <button onClick={onLogout} className="hidden lg:block text-slate-400 hover:text-red-500 transition-colors p-2" title="Logout">
                                <i className="fas fa-power-off"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: RISK BADGE ---
        const RiskBadge = ({ level, hex }) => {
            const getColor = () => {
                const l = (level || '').toLowerCase();
                if(l.includes('safe') || l.includes('low')) return 'bg-green-100 text-green-700 border-green-200';
                if(l.includes('critical') || l.includes('high') || l.includes('red')) return 'bg-red-100 text-red-700 border-red-200';
                if(l.includes('moderate') || l.includes('medium') || l.includes('yellow')) return 'bg-amber-100 text-amber-700 border-amber-200';
                return 'bg-slate-100 text-slate-600 border-slate-200';
            }

            return (
                <span className={`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wide border ${getColor()}`}>
                    <i className="fas fa-circle text-[8px]"></i>
                    {level || 'Unknown'}
                </span>
            );
        };

        // --- PAGE: HOME (OCR SCANNER) ---
        const Home = ({ patientId }) => {
            const [text, setText] = useState("");
            const [files, setFiles] = useState([]);
            const [previews, setPreviews] = useState([]); 
            const [loading, setLoading] = useState(false);
            const [loadingStep, setLoadingStep] = useState(""); 
            const [result, setResult] = useState(null);
            const [conditions, setConditions] = useState([]);
            const [language, setLanguage] = useState("English");
            const [isListening, setIsListening] = useState(false);

            const handleFileChange = (e) => {
                if (e.target.files) {
                    const newFiles = Array.from(e.target.files);
                    setFiles(prev => [...prev, ...newFiles]);
                    const newPreviews = newFiles.map(file => URL.createObjectURL(file));
                    setPreviews(prev => [...prev, ...newPreviews]);
                }
            };

            const removeFile = (index) => {
                const newFiles = [...files];
                const newPreviews = [...previews];
                newFiles.splice(index, 1);
                newPreviews.splice(index, 1);
                setFiles(newFiles);
                setPreviews(newPreviews);
            };

            const toggleCondition = (val) => {
                setConditions(prev => prev.includes(val) ? prev.filter(c => c !== val) : [...prev, val]);
            };

            const toggleSpeech = () => {
                if (!('webkitSpeechRecognition' in window)) {
                    alert("Voice input is not supported in this browser. Try Chrome or Edge.");
                    return;
                }

                const recognition = new window.webkitSpeechRecognition();
                recognition.lang = 'en-US';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => {
                    setIsListening(true);
                };

                recognition.onend = () => {
                    setIsListening(false);
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    setText(prev => prev + (prev ? " " : "") + transcript);
                };

                recognition.start();
            };

            const analyze = async () => {
                if (!files.length && !text) return alert("Please upload an image or enter text notes.");
                setLoading(true);
                setResult(null);
                setLoadingStep("Uploading...");
                const stepInterval = setInterval(() => {
                    setLoadingStep(prev => prev === "Uploading..." ? "Scanning..." : prev === "Scanning..." ? "Analyzing..." : "Finalizing...");
                }, 1500);

                const formData = new FormData();
                files.forEach(f => formData.append("image", f));
                if (text) formData.append("description", text);
                formData.append("patient_id", patientId);
                formData.append("language", language);
                if (conditions.length) formData.append("conditions", conditions.join(", "));

                try {
                    const res = await fetch("/api/analyze", { method: "POST", body: formData });
                    const json = await res.json();
                    clearInterval(stepInterval);
                    if(json.status === 'success') {
                        setResult(json.data);
                    } else {
                        alert("Error: " + json.error);
                    }
                } catch (err) {
                    console.error(err);
                    clearInterval(stepInterval);
                    alert("Analysis Failed. Ensure Backend is running on Port 5000.");
                } finally {
                    setLoading(false);
                }
            };

            const reset = () => {
                setResult(null);
                setFiles([]);
                setPreviews([]);
                setText("");
                setConditions([]);
            };

            return (
                <div className="max-w-6xl mx-auto pb-20 pt-6 animate-fade-in">
                    <div className="mb-8 flex items-end justify-between">
                        <div>
                            {/* Updated Header Color */}
                            <h2 className="text-3xl font-bold text-white tracking-tight">Prescription Analysis</h2>
                            <p className="text-slate-300 mt-1">AI-powered screening against new prescriptions and patient history.</p>
                        </div>
                    </div>

                    {!result ? (
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-slide-up">
                            {/* Inputs */}
                            <div className="lg:col-span-8 space-y-6">
                                {/* Notes Card */}
                                <div className="bg-white p-6 rounded-2xl shadow-soft border border-slate-100 hover:shadow-md transition-shadow">
                                    <div className="flex items-center justify-between mb-4">
                                        <label className="text-sm font-bold text-slate-700 uppercase tracking-wide">Clinical Context</label>
                                        <button 
                                            onClick={toggleSpeech}
                                            className={`text-sm font-semibold flex items-center gap-1 transition-colors ${isListening ? 'text-red-500 animate-pulse' : 'text-medical-600 hover:text-medical-700'}`}
                                        >
                                            <i className={`fas fa-microphone ${isListening ? 'fa-beat' : ''}`}></i> {isListening ? 'Listening...' : 'Dictate'}
                                        </button>
                                    </div>
                                    <textarea 
                                        className="w-full h-32 p-4 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-medical-500/20 focus:border-medical-500 outline-none resize-none text-slate-700 leading-relaxed transition-all"
                                        placeholder="Describe symptoms, current medications, or patient complaints..."
                                        value={text}
                                        onChange={(e) => setText(e.target.value)}
                                    ></textarea>
                                </div>

                                {/* Conditions Card */}
                                <div className="bg-white p-6 rounded-2xl shadow-soft border border-slate-100 hover:shadow-md transition-shadow">
                                    <label className="block text-sm font-bold text-slate-700 uppercase tracking-wide mb-4">Risk Factors</label>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                        {['Pregnancy', 'Elderly (65+)', 'Liver Issue', 'Hypertension'].map(c => (
                                            <button 
                                                key={c}
                                                onClick={() => toggleCondition(c)}
                                                className={`px-4 py-3 rounded-xl text-sm font-semibold border transition-all flex items-center justify-center gap-2 ${
                                                    conditions.includes(c) 
                                                    ? 'bg-medical-500 border-medical-500 text-white shadow-md transform scale-105' 
                                                    : 'bg-white border-slate-200 text-slate-500 hover:border-medical-300 hover:text-medical-600'
                                                }`}
                                            >
                                                {conditions.includes(c) && <i className="fas fa-check"></i>}
                                                {c}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Sidebar / Upload */}
                            <div className="lg:col-span-4 space-y-6">
                                <div className="bg-white p-6 rounded-2xl shadow-soft border border-slate-100 h-full flex flex-col">
                                    <label className="block text-sm font-bold text-slate-700 uppercase tracking-wide mb-4">Evidence</label>
                                    
                                    <div className="flex-1 flex flex-col gap-4">
                                        <label className={`flex-1 min-h-[200px] flex flex-col items-center justify-center border-2 border-dashed rounded-xl cursor-pointer transition-all duration-300 group relative overflow-hidden ${
                                            files.length ? 'border-medical-400 bg-medical-50/50' : 'border-slate-300 hover:border-medical-400 hover:bg-slate-50'
                                        }`}>
                                            <input type="file" multiple accept="image/*" className="hidden" onChange={handleFileChange} />
                                            <div className="z-10 flex flex-col items-center">
                                                <div className="w-14 h-14 bg-white rounded-full shadow-sm flex items-center justify-center mb-3 group-hover:scale-110 transition-transform text-medical-500">
                                                    <i className="fas fa-cloud-upload-alt text-2xl"></i>
                                                </div>
                                                <p className="text-sm font-bold text-slate-700">Upload Rx Images</p>
                                                <p className="text-xs text-slate-400 mt-1">JPG, PNG supported</p>
                                            </div>
                                        </label>

                                        {previews.length > 0 && (
                                            <div className="grid grid-cols-3 gap-2 animate-fade-in">
                                                {previews.map((src, i) => (
                                                    <div key={i} className="relative group aspect-square rounded-lg overflow-hidden border border-slate-200 shadow-sm">
                                                        <img src={src} className="w-full h-full object-cover" />
                                                        <button onClick={() => removeFile(i)} className="absolute top-1 right-1 bg-white/90 text-red-500 rounded-full w-6 h-6 flex items-center justify-center shadow-sm opacity-0 group-hover:opacity-100 transition-opacity">
                                                            <i className="fas fa-times text-xs"></i>
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    <div className="mt-6 space-y-4 pt-6 border-t border-slate-100">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Language</label>
                                            <select 
                                                value={language}
                                                onChange={(e) => setLanguage(e.target.value)}
                                                className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-medical-500"
                                            >
                                                <option>English</option>
                                                <option>Hindi (हिंदी)</option>
                                                <option>Spanish (Español)</option>
                                                <option>French (Français)</option>
                                            </select>
                                        </div>

                                        <button 
                                            onClick={analyze}
                                            disabled={loading || (!files.length && !text)}
                                            className="w-full bg-gradient-to-r from-medical-600 to-medical-500 hover:from-medical-500 hover:to-medical-400 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl hover:shadow-medical-500/30 transform hover:-translate-y-0.5 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                        >
                                            {loading ? <span className="flex items-center justify-center gap-2"><i className="fas fa-circle-notch fa-spin"></i> {loadingStep}</span> : "Analyze Prescription"}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="animate-slide-up max-w-4xl mx-auto">
                            <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
                                <div className="p-8 bg-slate-50 border-b border-slate-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                    <div>
                                        <h3 className="text-2xl font-bold text-slate-800">Clinical Assessment</h3>
                                        <p className="text-slate-500 text-sm mt-1">Generated based on provided evidence and history.</p>
                                    </div>
                                    <RiskBadge level={result.risk_level} hex={result.risk_hex} />
                                </div>

                                <div className="p-8 space-y-8">
                                    <div>
                                        <h4 className="flex items-center gap-2 text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">
                                            Identified Medications
                                        </h4>
                                        <div className="flex flex-wrap gap-2">
                                            {result.medicines_found && result.medicines_found.length ? result.medicines_found.map((m, i) => (
                                                <span key={i} className="px-4 py-2 bg-white text-slate-700 rounded-lg text-sm font-semibold border border-slate-200 shadow-sm">
                                                    {m}
                                                </span>
                                            )) : <span className="text-sm text-slate-400 italic">None detected.</span>}
                                        </div>
                                    </div>

                                    <div>
                                        <h4 className="flex items-center gap-2 text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">
                                            Analysis
                                        </h4>
                                        <div className="bg-blue-50/50 p-6 rounded-xl border border-blue-100 text-slate-800 leading-relaxed text-lg">
                                            {result.alert_message}
                                        </div>
                                    </div>

                                    {result.alternatives && result.alternatives.length > 0 && (
                                        <div className="animate-fade-in">
                                            <h4 className="flex items-center gap-2 text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">
                                                Recommendations
                                            </h4>
                                            <ul className="grid gap-3">
                                                {result.alternatives.map((alt, i) => (
                                                    <li key={i} className="bg-green-50 p-4 rounded-xl border border-green-100 text-sm text-green-800 font-medium flex items-center gap-3">
                                                        <div className="w-6 h-6 rounded-full bg-green-200 flex items-center justify-center shrink-0 text-green-700 text-xs"><i className="fas fa-check"></i></div>
                                                        <span>{alt}</span>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}
                                </div>

                                <div className="bg-slate-50 px-8 py-6 border-t border-slate-100 flex justify-between items-center">
                                    <button onClick={() => setResult(null)} className="text-slate-500 hover:text-medical-600 font-semibold text-sm flex items-center gap-2 transition-colors">
                                        <i className="fas fa-arrow-left"></i> New Analysis
                                    </button>
                                    <button onClick={() => window.print()} className="bg-white border border-slate-200 hover:border-medical-300 text-slate-700 px-5 py-2.5 rounded-lg text-sm font-bold shadow-sm transition-all flex items-center gap-2">
                                        <i className="fas fa-print"></i> Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- PAGE: HISTORY ---
        const History = ({ patientId }) => {
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if(!patientId) return;
                setLoading(true);
                
                fetch(`/api/history?patient_id=${patientId}`)
                    .then(res => res.json())
                    .then(json => {
                        if(json.status === 'success') {
                            setHistory(json.data);
                        }
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setLoading(false);
                    });
            }, [patientId]);

            return (
                <div className="max-w-5xl mx-auto animate-fade-in pt-6">
                    {/* Updated Header Color */}
                    <div className="flex justify-between items-center mb-8">
                        <div>
                            <h2 className="text-3xl font-bold text-white">Patient History</h2>
                            <p className="text-slate-300 text-sm mt-1">Records for Patient ID: <span className="font-bold text-white">{patientId}</span></p>
                        </div>
                    </div>

                    {loading ? (
                        <div className="text-center py-20 text-slate-400">
                            <i className="fas fa-spinner fa-spin text-3xl"></i>
                            <p className="mt-4">Loading records...</p>
                        </div>
                    ) : history.length === 0 ? (
                        <div className="text-center py-20 bg-white rounded-2xl border border-dashed border-slate-300">
                            <p className="text-slate-500 font-medium">No records found for {patientId}</p>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {history.map(entry => (
                                <div key={entry.id} className="bg-white p-6 rounded-2xl border border-slate-100 shadow-soft hover:shadow-md transition-all group">
                                    <div className="flex justify-between items-start mb-4">
                                        <div className="text-sm font-bold text-slate-400 uppercase tracking-wide">{new Date(entry.date).toLocaleDateString()}</div>
                                        <RiskBadge level={entry.risk} />
                                    </div>
                                    <div className="flex flex-wrap gap-2 mb-4">
                                        {entry.meds.map((m, i) => <span key={i} className="text-xs font-bold text-slate-600 bg-slate-100 px-3 py-1.5 rounded-lg">{m}</span>)}
                                    </div>
                                    <p className="text-sm text-slate-600 leading-relaxed bg-slate-50 p-4 rounded-xl">{entry.alert}</p>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- PAGE: MEDICINE INFO ---
        const MedicineInfo = () => {
            const [search, setSearch] = useState("");
            const [drugs, setDrugs] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                const fetchDrugs = async () => {
                    setLoading(true);
                    try {
                        const res = await fetch(`/api/drugs?search=${search}`);
                        const json = await res.json();
                        if (json.status === 'success') {
                            setDrugs(json.data);
                        }
                    } catch (err) {
                        console.error(err);
                    } finally {
                        setLoading(false);
                    }
                };

                const delayDebounceFn = setTimeout(() => {
                    fetchDrugs();
                }, 300); // Debounce typing

                return () => clearTimeout(delayDebounceFn);
            }, [search]);

            return (
                <div className="max-w-5xl mx-auto animate-fade-in pt-6">
                    <div className="text-center mb-10">
                        {/* Updated Header Color */}
                        <h2 className="text-3xl font-extrabold text-white mb-2">Drug Reference</h2>
                        <p className="text-slate-300">Quick access to safety information and warnings.</p>
                    </div>

                    <div className="max-w-xl mx-auto relative mb-12">
                        <i className="fas fa-search absolute left-5 top-4 text-slate-400 text-lg"></i>
                        <input 
                            type="text" 
                            placeholder="Search generic or brand names..." 
                            className="w-full pl-12 pr-6 py-4 rounded-2xl border border-slate-200 shadow-soft focus:ring-4 focus:ring-medical-100 focus:border-medical-500 outline-none text-lg font-medium transition-all"
                            value={search}
                            onChange={(e) => setSearch(e.target.value)}
                        />
                    </div>

                    {loading ? (
                        <div className="text-center text-slate-400 py-10"><i className="fas fa-spinner fa-spin text-2xl"></i></div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {drugs.length === 0 ? (
                                <p className="text-center col-span-full text-slate-400">No medicines found.</p>
                            ) : (
                                drugs.map(med => (
                                    <div key={med.id} className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:border-medical-300 transition-colors">
                                        <div className="flex justify-between items-start mb-4">
                                            <h3 className="font-bold text-medical-700 text-xl">{med.name}</h3>
                                            <span className="text-xs font-bold bg-slate-100 text-slate-600 px-2 py-1 rounded uppercase">{med.category}</span>
                                        </div>
                                        
                                        <div className="space-y-3">
                                            <div>
                                                <span className="text-xs font-bold text-slate-400 uppercase">Usage</span>
                                                <p className="text-sm text-slate-700">{med.use}</p>
                                            </div>
                                            <div>
                                                <span className="text-xs font-bold text-slate-400 uppercase">Side Effects</span>
                                                <p className="text-sm text-slate-700">{med.side_effects}</p>
                                            </div>
                                            <div className="bg-amber-50 text-amber-800 text-xs p-3 rounded-lg font-medium border border-amber-100 flex gap-2">
                                                <i className="fas fa-exclamation-triangle mt-0.5"></i> 
                                                <span>{med.caution}</span>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // --- PAGE: INTERACTION CHECKER ---
        const Checker = () => {
            const [medA, setMedA] = useState("Warfarin");
            const [medB, setMedB] = useState("Aspirin");
            const [checking, setChecking] = useState(false);
            const [result, setResult] = useState(null);
            const [drugList, setDrugList] = useState([]);

            // Fetch drug list for dropdown
            useEffect(() => {
                fetch('/api/drugs')
                    .then(res => res.json())
                    .then(json => {
                        if (json.status === 'success') {
                            setDrugList(json.data);
                        }
                    });
            }, []);

            const handleCheck = () => {
                setChecking(true);
                setResult(null);
                setTimeout(() => {
                    setChecking(false);
                    // Mock Logic
                    if ((medA === 'Warfarin' && medB === 'Aspirin') || (medA === 'Aspirin' && medB === 'Warfarin')) {
                        setResult({ risk: 'High', msg: 'Major Interaction: Increased risk of bleeding.' });
                    } else {
                        setResult({ risk: 'Low', msg: 'No major interactions found in database.' });
                    }
                }, 800);
            };

            return (
                <div className="max-w-2xl mx-auto animate-fade-in pt-10">
                    {/* Updated Header Color */}
                    <h2 className="text-3xl font-bold text-white mb-2 text-center">Quick Check</h2>
                    <p className="text-slate-300 mb-8 text-center">Manual lookup for specific drug combinations.</p>
                    
                    <div className="bg-white p-8 rounded-2xl border border-slate-200 shadow-lg space-y-6 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-medical-400 to-medical-600"></div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                            <div className="space-y-2">
                                <label className="block text-xs font-bold text-slate-400 uppercase">Medicine A</label>
                                <select 
                                    value={medA} onChange={(e) => setMedA(e.target.value)}
                                    className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium text-slate-700 focus:border-medical-500 transition-colors"
                                >
                                    {drugList.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}
                                </select>
                            </div>

                            <div className="hidden md:flex justify-center text-slate-300">
                                <i className="fas fa-exchange-alt text-2xl"></i>
                            </div>

                            <div className="space-y-2">
                                <label className="block text-xs font-bold text-slate-400 uppercase">Medicine B</label>
                                <select 
                                    value={medB} onChange={(e) => setMedB(e.target.value)}
                                    className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium text-slate-700 focus:border-medical-500 transition-colors"
                                >
                                    {drugList.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}
                                </select>
                            </div>
                        </div>

                        <button 
                            onClick={handleCheck}
                            disabled={checking}
                            className="w-full bg-slate-900 text-white font-bold py-4 rounded-xl hover:bg-slate-800 transition-all mt-4 shadow-lg flex justify-center items-center gap-2"
                        >
                            {checking ? <i className="fas fa-spinner fa-spin"></i> : <span>Verify Safety <i className="fas fa-check ml-1"></i></span>}
                        </button>
                    </div>
                    
                    {/* Result */}
                    {result && (
                        <div className={`mt-6 p-5 rounded-xl border flex items-start gap-4 animate-slide-up ${
                            result.risk === 'High' ? 'bg-red-50 border-red-100' : 'bg-green-50 border-green-100'
                        }`}>
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${
                                result.risk === 'High' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'
                            }`}>
                                <i className={`fas ${result.risk === 'High' ? 'fa-exclamation' : 'fa-check'}`}></i>
                            </div>
                            <div>
                                <h4 className={`font-bold ${result.risk === 'High' ? 'text-red-800' : 'text-green-800'}`}>
                                    {result.risk === 'High' ? 'Interaction Detected' : 'Likely Safe'}
                                </h4>
                                <p className={`text-sm mt-1 ${result.risk === 'High' ? 'text-red-700' : 'text-green-700'}`}>
                                    {result.msg}
                                </p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- MAIN APP CONTAINER ---
        const App = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [patientId, setPatientId] = useState("");
            const [activeTab, setActiveTab] = useState("home");

            const handleLogin = (id) => {
                setPatientId(id);
                setIsLoggedIn(true);
            };

            const handleLogout = () => {
                setIsLoggedIn(false);
                setPatientId("");
                setActiveTab("home");
            };

            if (!isLoggedIn) return <LoginOverlay onLogin={handleLogin} />;

            return (
                <div className="flex h-screen font-sans overflow-hidden relative">
                    {/* Background Animation (Persists after login) */}
                    <div className="absolute inset-0 z-0 bg-gradient-to-br from-slate-900 via-medical-900 to-slate-900 pointer-events-none">
                        <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-medical-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-float"></div>
                        <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-float" style={{animationDelay: '2s'}}></div>
                    </div>

                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} user={patientId} onLogout={handleLogout} />
                    
                    <div className="flex-1 flex flex-col h-screen overflow-hidden relative z-10">
                        {/* Mobile Header */}
                        <div className="lg:hidden bg-white/80 backdrop-blur p-4 border-b border-slate-100 flex justify-between items-center z-10 sticky top-0">
                            <span className="font-extrabold text-slate-800 flex items-center gap-2">
                                {/* UPDATED LOGO HERE */}
                                <img src="logo medimatch.png" alt="Logo" className="h-10 w-auto object-contain" />
                            </span>
                            <button onClick={handleLogout} className="text-slate-400"><i className="fas fa-power-off"></i></button>
                        </div>

                        {/* Main Content Area */}
                        <main className="flex-1 overflow-y-auto p-4 md:p-8 lg:p-12 scrollbar-hide">
                            {activeTab === 'home' && <Home patientId={patientId} />}
                            {activeTab === 'history' && <History patientId={patientId} />}
                            {activeTab === 'info' && <MedicineInfo />}
                            {activeTab === 'checker' && <Checker />}
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>